@page "/productos/editar/{IdProducto:int}" // Ruta con parámetro ID
@using DTOs
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveWebAssembly

<PageTitle>Editar Producto</PageTitle>

<h3>Editar Producto</h3>

@if (productoParaEditar == null && cargando) // Muestra cargando mientras busca el producto
{
    <p><em>Cargando datos del producto...</em></p>
}
else if (productoParaEditar != null) // Muestra el formulario si se encontró
{
    <EditForm Model="productoParaEditar" OnValidSubmit="HandleValidSubmit" FormName="editarProductoForm">
        <DataAnnotationsValidator />

        @* Campos del formulario (iguales a ProductoAgregar, pero usan 'productoParaEditar') *@
        <div class="mb-3">
            <label for="nombre" class="form-label">Nombre:</label>
            <InputText id="nombre" class="form-control" @bind-Value="productoParaEditar.Nombre" />
            <ValidationMessage For="() => productoParaEditar.Nombre" />
        </div>

        <div class="mb-3">
            <label for="descripcion" class="form-label">Descripción:</label>
            <InputTextArea id="descripcion" class="form-control" @bind-Value="productoParaEditar.Descripcion" />
        </div>

        <div class="mb-3">
            <label for="categoria" class="form-label">Categoría:</label>
            @if (categorias == null)
            {
                <p>Cargando categorías...</p>
            }
            else
            {
                <InputSelect id="categoria" class="form-select" @bind-Value="productoParaEditar.IdCatProducto">
                    <option value="0">-- Seleccione una categoría --</option>
                    @foreach (var cat in categorias)
                    {
                        <option value="@cat.IdCatProducto">@cat.Nombre</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => productoParaEditar.IdCatProducto" />
            }
        </div>

        <div class="mb-3">
            <label for="precio" class="form-label">Precio Actual:</label>
            <InputNumber TValue="decimal" id="precio" class="form-control" @bind-Value="productoParaEditar.PrecioActual" />
            <ValidationMessage For="() => productoParaEditar.PrecioActual" />
        </div>

        <div class="mb-3">
            <label for="stock" class="form-label">Stock:</label>
            <InputNumber TValue="int" id="stock" class="form-control" @bind-Value="productoParaEditar.Stock" />
            <ValidationMessage For="() => productoParaEditar.Stock" />
        </div>

        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        <button type="button" class="btn btn-secondary" @onclick="VolverADetalle">Cancelar</button>

    </EditForm>
}
else // Muestra si no se encontró el producto a editar
{
    <p class="text-danger">No se pudo cargar el producto para editar o no existe.</p>
    <button class="btn btn-secondary" @onclick="VolverAProductos">Volver al listado</button>
}


@code {
    [Parameter] // Recibe el ID desde la URL
    public int IdProducto { get; set; }

    // Objeto para guardar los datos del producto a editar
    private ProductoDTO? productoParaEditar;

    // Para el desplegable de categorías
    private List<CategoriaDTO>? categorias;

    private bool cargando = true; // Controla mensaje inicial
    private string? errorApi; // Para mostrar errores de la API

    // Se ejecuta al cargar la página: busca categorías Y el producto a editar
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Carga las categorías (igual que en Agregar)
            categorias = await Http.GetFromJsonAsync<List<CategoriaDTO>>("categorias");

            // Carga el producto específico usando el IdProducto de la URL
            productoParaEditar = await Http.GetFromJsonAsync<ProductoDTO>($"productos/{IdProducto}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar datos para editar: {ex.Message}");
            productoParaEditar = null; // Si falla, no mostramos el form
        }
        finally
        {
            cargando = false; // Terminó de cargar
        }
    }

    // Se ejecuta al enviar el formulario válido
    private async Task HandleValidSubmit()
    {
        errorApi = null; // Limpia errores previos
        if (productoParaEditar == null) return; // Seguridad extra

        // Validación simple para la categoría
        if (productoParaEditar.IdCatProducto <= 0)
        {
            MessageBox(IntPtr.Zero, "Debe seleccionar una categoría.", "Validación", 0);
            return;
        }

        try
        {
            // Llama al endpoint PUT /productos de tu API
            var response = await Http.PutAsJsonAsync("productos", productoParaEditar);

            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo($"/productos/{IdProducto}"); // Vuelve a la PÁGINA DE DETALLE si se guardó bien
            }
            else
            {
                // Muestra errores de la API
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error de API al actualizar: {errorContent}");
                errorApi = $"Error al guardar: {errorContent}"; // Guarda el error para mostrarlo (opcional)
                MessageBox(IntPtr.Zero, $"Error al guardar cambios: {errorContent}", "Error API", 0);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inesperado al guardar cambios: {ex.Message}");
            errorApi = $"Error inesperado: {ex.Message}";
            MessageBox(IntPtr.Zero, $"Error inesperado: {ex.Message}", "Error", 0);
        }
    }

    // Método para el botón "Cancelar" - Vuelve a la página de Detalle
    private void VolverADetalle()
    {
        Navigation.NavigateTo($"/productos/{IdProducto}");
    }
    // Método para el botón "Volver al listado" (si falla la carga inicial)
    private void VolverAProductos()
    {
        Navigation.NavigateTo("/productos");
    }

    // --- Truco MessageBox ---
    [System.Runtime.InteropServices.DllImport("user32.dll", CharSet = System.Runtime.InteropServices.CharSet.Unicode)]
    public static extern int MessageBox(IntPtr hWnd, String text, String caption, uint type);
    // --- Fin Truco ---
}